// Define canvas and context
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Player object
const player = {
    x: 50,
    y: canvas.height - 100,
    width: 30,
    height: 50,
    speedY: 0,
    gravity: 1,
    onGround: false,
    hat: localStorage.getItem('hat') || null // Retrieve saved hat from localStorage
};

// Obstacles (spikes)
let obstacles = [];
let obstacleSpeed = 5;
let jumpedOver = false;

// Score
let score = 0;
let gameOver = false;

// Show outlines of obstacles (optional)
let showOutline = false;

// Create a spike obstacle
function createSpike() {
    const spike = {
        x: canvas.width,
        y: canvas.height - 20,
        width: 40,
        height: Math.random() * 60 + 20 // Random height for spikes
    };
    obstacles.push(spike);
}

// Render game
function renderGame() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw player
    ctx.fillStyle = '#FF6347';
    ctx.beginPath();
    ctx.ellipse(player.x + player.width / 2, player.y + player.height / 2, player.width / 2, player.height / 2, 0, 0, Math.PI * 2);
    ctx.fill();

    // Draw the hat based on score
    if (player.hat === 'trollHat') {
        ctx.fillStyle = 'rgba(255, 0, 255, 1)'; // Troll hat color
        ctx.fillText('ðŸ˜„', player.x + 13, player.y - 10); // Troll face moved 3px more to the right
    } else if (player.hat === 'demonHorns') {
        const demonHornsImage = new Image();
        demonHornsImage.src = 'https://totallyeducational.homes/v2.png';
        ctx.drawImage(demonHornsImage, player.x - 10, player.y - 25, 70, 40); // Moved horns down 5 more px
    } else if (player.hat === 'devHat') {
        // Create rainbow gradient for 'Developer' text
        const gradient = ctx.createLinearGradient(player.x, player.y - 30, player.x + 100, player.y - 30);
        gradient.addColorStop(0, 'red');
        gradient.addColorStop(0.2, 'orange');
        gradient.addColorStop(0.4, 'yellow');
        gradient.addColorStop(0.6, 'green');
        gradient.addColorStop(0.8, 'blue');
        gradient.addColorStop(1, 'violet');

        ctx.fillStyle = gradient;
        ctx.font = '20px Arial';
        ctx.fillText('Developer', player.x - 10, player.y - 10); // Positioning the rainbow text above the player
    }

    // Draw red spikes (triangles)
    obstacles.forEach(spike => {
        ctx.fillStyle = '#FF0000';
        ctx.beginPath();
        ctx.moveTo(spike.x, canvas.height);
        ctx.lineTo(spike.x + spike.width / 2, canvas.height - spike.height);
        ctx.lineTo(spike.x + spike.width, canvas.height);
        ctx.closePath();
        ctx.fill();

        // Draw outlines if enabled
        if (showOutline) {
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    });

    // Draw score
    ctx.fillStyle = '#FFF';
    ctx.font = '20px Arial';
    ctx.fillText(`Score: ${score}`, 20, 30);
}

// Update game logic for hats
function updateGame() {
    if (!gameOver) {
        // Update player
        player.speedY += player.gravity;
        player.y += player.speedY;

        if (player.y + player.height >= canvas.height) {
            player.y = canvas.height - player.height;
            player.speedY = 0;
            player.onGround = true;
            jumpedOver = false; // Reset jump over flag
        }

        // Update obstacles (spikes)
        obstacles.forEach(spike => {
            spike.x -= obstacleSpeed;
        });

        // Remove obstacles that have gone off screen
        obstacles = obstacles.filter(spike => spike.x + spike.width > 0);

        // Create new obstacles with more spacing
        if (Math.random() < 0.02 && (obstacles.length === 0 || obstacles[obstacles.length - 1].x < canvas.width - 200)) {
            createSpike();
        }

        // Collision detection
        obstacles.forEach(spike => {
            if (player.x < spike.x + spike.width && player.x + player.width > spike.x &&
                player.y < spike.y + spike.height && player.y + player.height > spike.y) {
                gameOver = true;
            }

            // Check if player jumped over the spike
            if (player.x > spike.x + spike.width && !jumpedOver) {
                score++;
                jumpedOver = true; // Mark spike as jumped over

                // Check for hats based on score
                if (score >= 100000) {
                    player.hat = 'devHat'; // Dev hat for 100,000 score
                    localStorage.setItem('hat', player.hat); // Save to localStorage
                } else if (score >= 200) {
                    player.hat = 'demonHorns'; // Demon horns hat
                    localStorage.setItem('hat', player.hat); // Save to localStorage
                } else if (score >= 100) {
                    player.hat = 'trollHat'; // Troll face hat
                    localStorage.setItem('hat', player.hat); // Save to localStorage
                }
            }
        });
    }
}

// Start game function
function startGame() {
    score = 0;
    gameOver = false;
    obstacles = [];
    player.y = canvas.height - 100;
    player.speedY = 0;
    player.hat = localStorage.getItem('hat') || null;

    // Start game loop
    requestAnimationFrame(gameLoop);
}

// Game loop
function gameLoop() {
    updateGame();
    renderGame();
    if (!gameOver) {
        requestAnimationFrame(gameLoop);
    }
}

// Event listener for starting the game
document.getElementById('startButton').addEventListener('click', () => {
    startGame();
});
